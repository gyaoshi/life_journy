<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²ç³»ç»Ÿæµ‹è¯• - äººç”Ÿæ—…ç¨‹æ¸¸æˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .game-canvas {
            border: 2px solid #333;
            background: linear-gradient(to bottom, #87CEEB, #98FB98);
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .control-group {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-group h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .emotion-btn {
            background: #FF6B6B;
        }
        
        .emotion-btn:hover {
            background: #FF5252;
        }
        
        .event-btn {
            background: #4ECDC4;
        }
        
        .event-btn:hover {
            background: #26A69A;
        }
        
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .instructions {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® è§’è‰²ç³»ç»Ÿæµ‹è¯•</h1>
            <p>æµ‹è¯•æ–°çš„äººç‰©äº¤äº’ç§»åŠ¨ç³»ç»Ÿå’Œè§’è‰²è§†è§‰æ›¿æ¢åŠŸèƒ½</p>
        </div>
        
        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š</h3>
            <ul>
                <li><strong>ç‚¹å‡»ç”»é¢</strong> - è§’è‰²ä¼šç§»åŠ¨åˆ°ç‚¹å‡»ä½ç½®</li>
                <li><strong>åˆ‡æ¢äººç”Ÿé˜¶æ®µ</strong> - è§‚å¯Ÿè§’è‰²å½¢æ€å˜åŒ–</li>
                <li><strong>æ”¹å˜æƒ…æ„Ÿ</strong> - æŸ¥çœ‹è§’è‰²è¡¨æƒ…å˜åŒ–</li>
                <li><strong>è§¦å‘äº‹ä»¶</strong> - è§’è‰²ä¼šç§»åŠ¨åˆ°äº‹ä»¶ä½ç½®å¹¶æ’­æ”¾åŠ¨ç”»</li>
                <li><strong>é»„è‰²è™šçº¿æ¡†</strong> - è¡¨ç¤ºå¯ç‚¹å‡»çš„ç‰¹æ®ŠåŒºåŸŸ</li>
            </ul>
        </div>
        
        <canvas id="gameCanvas" class="game-canvas" width="800" height="600"></canvas>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸ‘¶ äººç”Ÿé˜¶æ®µ</h3>
                <button onclick="changeStage('baby')">å©´å„¿æœŸ</button>
                <button onclick="changeStage('child')">å„¿ç«¥æœŸ</button>
                <button onclick="changeStage('teen')">é’å°‘å¹´æœŸ</button>
                <button onclick="changeStage('adult')">æˆå¹´æœŸ</button>
                <button onclick="changeStage('elder')">è€å¹´æœŸ</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ˜Š æƒ…æ„Ÿè¡¨è¾¾</h3>
                <button class="emotion-btn" onclick="changeEmotion('happy')">å¼€å¿ƒ</button>
                <button class="emotion-btn" onclick="changeEmotion('sad')">æ‚²ä¼¤</button>
                <button class="emotion-btn" onclick="changeEmotion('surprised')">æƒŠè®¶</button>
                <button class="emotion-btn" onclick="changeEmotion('excited')">å…´å¥‹</button>
                <button class="emotion-btn" onclick="changeEmotion('neutral')">ä¸­æ€§</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¯ äººç”Ÿäº‹ä»¶</h3>
                <button class="event-btn" onclick="triggerEvent('first_smile')">ç¬¬ä¸€æ¬¡å¾®ç¬‘</button>
                <button class="event-btn" onclick="triggerEvent('first_day_kindergarten')">ç¬¬ä¸€å¤©ä¸Šå­¦</button>
                <button class="event-btn" onclick="triggerEvent('make_first_friend')">äº¤æœ‹å‹</button>
                <button class="event-btn" onclick="triggerEvent('first_job')">ç¬¬ä¸€ä»½å·¥ä½œ</button>
                <button class="event-btn" onclick="triggerEvent('wedding_ceremony')">ç»“å©šå…¸ç¤¼</button>
            </div>
            
            <div class="control-group">
                <h3>âš™ï¸ ç³»ç»Ÿæ§åˆ¶</h3>
                <button onclick="toggleInteraction()">åˆ‡æ¢äº¤äº’</button>
                <button onclick="toggleHints()">åˆ‡æ¢æç¤º</button>
                <button onclick="resetPosition()">é‡ç½®ä½ç½®</button>
                <button onclick="testTransition()">æµ‹è¯•è½¬æ¢</button>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="status">
                <span><strong>å½“å‰é˜¶æ®µ:</strong> <span id="currentStage">å©´å„¿æœŸ</span></span>
                <span><strong>å½“å‰æƒ…æ„Ÿ:</strong> <span id="currentEmotion">ä¸­æ€§</span></span>
                <span><strong>ä½ç½®:</strong> <span id="currentPosition">(400, 300)</span></span>
                <span><strong>ç§»åŠ¨çŠ¶æ€:</strong> <span id="movementStatus">é™æ­¢</span></span>
            </div>
            <div id="eventLog" style="max-height: 100px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 4px;">
                <div>ğŸ® ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œç‚¹å‡»ç”»é¢å¼€å§‹ä½“éªŒï¼</div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æ ¸å¿ƒæ¨¡å— -->
    <script src="core/CharacterRenderer.js"></script>
    <script src="characters/CharacterAssets.js"></script>
    <script src="core/MovementController.js"></script>
    <script src="core/InteractionManager.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let canvas, ctx;
        let characterRenderer, characterAssets, movementController, interactionManager;
        let currentStage = 'baby';
        let currentEmotion = 'neutral';
        let isInteractionEnabled = true;
        let showHints = true;
        
        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // åˆ›å»ºè§’è‰²èµ„æºç®¡ç†å™¨
            characterAssets = new CharacterAssets();
            
            // åˆ›å»ºè§’è‰²æ¸²æŸ“å™¨
            characterRenderer = new CharacterRenderer(ctx, { scale: 1.0 });
            
            // åˆ›å»ºç§»åŠ¨æ§åˆ¶å™¨
            const mockCharacter = {
                setPosition: (x, y) => {
                    updatePositionDisplay(x, y);
                },
                setAnimationState: (state, options) => {
                    updateMovementStatus(state);
                },
                setFacing: (direction) => {
                    logEvent(`è§’è‰²æœå‘: ${direction}`);
                }
            };
            
            const mockScene = {
                setBackground: (sceneName) => {
                    logEvent(`åœºæ™¯åˆ‡æ¢: ${sceneName}`);
                }
            };
            
            movementController = new MovementController(mockCharacter, mockScene, {
                speed: 150,
                easing: 'easeInOutQuad',
                pathType: 'direct'
            });
            
            // åˆ›å»ºäº¤äº’ç®¡ç†å™¨
            interactionManager = new InteractionManager(
                canvas, 
                movementController, 
                null, // æš‚æ—¶ä¸ä½¿ç”¨åŠ¨ç”»å¼•æ“
                {
                    showMovementHints: true,
                    showEventPositions: true
                }
            );
            
            // è®¾ç½®åˆå§‹ä½ç½®
            movementController.setPosition(400, 300);
            
            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            startRenderLoop();
            
            logEvent('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
        }
        
        // æ¸²æŸ“å¾ªç¯
        function startRenderLoop() {
            function render() {
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼ï¼ˆå¯é€‰ï¼‰
                drawGrid();
                
                // æ¸²æŸ“è§’è‰²
                const position = movementController.getCurrentPosition();
                characterRenderer.renderCharacter(currentStage, position, currentEmotion);
                
                // æ¸²æŸ“äº¤äº’æç¤º
                interactionManager.renderInteractionHints(ctx);
                
                // ç»§ç»­ä¸‹ä¸€å¸§
                requestAnimationFrame(render);
            }
            
            render();
        }
        
        // ç»˜åˆ¶ç½‘æ ¼èƒŒæ™¯
        function drawGrid() {
            ctx.save();
            ctx.strokeStyle = 'rgba(200, 200, 200, 0.3)';
            ctx.lineWidth = 1;
            
            // å‚ç›´çº¿
            for (let x = 0; x <= canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // æ°´å¹³çº¿
            for (let y = 0; y <= canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            ctx.restore();
        }
        
        // æ§åˆ¶å‡½æ•°
        function changeStage(newStage) {
            if (characterRenderer.isTransitioning) {
                logEvent('âš ï¸ æ­£åœ¨è½¬æ¢ä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            const oldStage = currentStage;
            currentStage = newStage;
            
            // æ‰§è¡Œå½¢æ€è½¬æ¢
            characterRenderer.transitionToStage(oldStage, newStage, 1500)
                .then(() => {
                    logEvent(`âœ¨ æˆåŠŸè½¬æ¢åˆ°${getStageDisplayName(newStage)}`);
                    updateStageDisplay(newStage);
                })
                .catch(error => {
                    logEvent(`âŒ è½¬æ¢å¤±è´¥: ${error.message}`);
                });
        }
        
        function changeEmotion(emotion) {
            currentEmotion = emotion;
            characterRenderer.setCharacterEmotion(emotion);
            updateEmotionDisplay(emotion);
            logEvent(`ğŸ˜Š æƒ…æ„Ÿå˜åŒ–: ${getEmotionDisplayName(emotion)}`);
        }
        
        function triggerEvent(eventType) {
            logEvent(`ğŸ¯ è§¦å‘äº‹ä»¶: ${getEventDisplayName(eventType)}`);
            
            interactionManager.handleEventTrigger(eventType, {
                stage: currentStage,
                emotion: currentEmotion
            }).then(() => {
                logEvent(`âœ… äº‹ä»¶å®Œæˆ: ${getEventDisplayName(eventType)}`);
            }).catch(error => {
                logEvent(`âŒ äº‹ä»¶å¤±è´¥: ${error.message}`);
            });
        }
        
        function toggleInteraction() {
            isInteractionEnabled = !isInteractionEnabled;
            interactionManager.setInteractionEnabled(isInteractionEnabled);
            logEvent(`ğŸ® äº¤äº’${isInteractionEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        }
        
        function toggleHints() {
            showHints = !showHints;
            interactionManager.showMovementHints = showHints;
            interactionManager.showEventPositions = showHints;
            logEvent(`ğŸ’¡ æç¤º${showHints ? 'æ˜¾ç¤º' : 'éšè—'}`);
        }
        
        function resetPosition() {
            movementController.setPosition(400, 300);
            logEvent('ğŸ  ä½ç½®å·²é‡ç½®åˆ°ä¸­å¿ƒ');
        }
        
        function testTransition() {
            const stages = ['baby', 'child', 'teen', 'adult', 'elder'];
            const currentIndex = stages.indexOf(currentStage);
            const nextIndex = (currentIndex + 1) % stages.length;
            changeStage(stages[nextIndex]);
        }
        
        // æ˜¾ç¤ºæ›´æ–°å‡½æ•°
        function updateStageDisplay(stage) {
            document.getElementById('currentStage').textContent = getStageDisplayName(stage);
        }
        
        function updateEmotionDisplay(emotion) {
            document.getElementById('currentEmotion').textContent = getEmotionDisplayName(emotion);
        }
        
        function updatePositionDisplay(x, y) {
            document.getElementById('currentPosition').textContent = `(${Math.round(x)}, ${Math.round(y)})`;
        }
        
        function updateMovementStatus(status) {
            const statusMap = {
                'idle': 'é™æ­¢',
                'walking': 'è¡Œèµ°ä¸­',
                'running': 'å¥”è·‘ä¸­'
            };
            document.getElementById('movementStatus').textContent = statusMap[status] || status;
        }
        
        function logEvent(message) {
            const eventLog = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            eventLog.appendChild(logEntry);
            eventLog.scrollTop = eventLog.scrollHeight;
        }
        
        // è¾…åŠ©å‡½æ•°
        function getStageDisplayName(stage) {
            const stageNames = {
                'baby': 'å©´å„¿æœŸ',
                'child': 'å„¿ç«¥æœŸ',
                'teen': 'é’å°‘å¹´æœŸ',
                'adult': 'æˆå¹´æœŸ',
                'elder': 'è€å¹´æœŸ'
            };
            return stageNames[stage] || stage;
        }
        
        function getEmotionDisplayName(emotion) {
            const emotionNames = {
                'happy': 'å¼€å¿ƒ',
                'sad': 'æ‚²ä¼¤',
                'surprised': 'æƒŠè®¶',
                'excited': 'å…´å¥‹',
                'neutral': 'ä¸­æ€§',
                'sleepy': 'å›°å€¦'
            };
            return emotionNames[emotion] || emotion;
        }
        
        function getEventDisplayName(eventType) {
            const eventNames = {
                'first_smile': 'ç¬¬ä¸€æ¬¡å¾®ç¬‘',
                'first_day_kindergarten': 'ç¬¬ä¸€å¤©ä¸Šå­¦',
                'make_first_friend': 'äº¤åˆ°ç¬¬ä¸€ä¸ªæœ‹å‹',
                'first_job': 'ç¬¬ä¸€ä»½å·¥ä½œ',
                'wedding_ceremony': 'ç»“å©šå…¸ç¤¼'
            };
            return eventNames[eventType] || eventType;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initializeSystem);
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (event) => {
            switch(event.key) {
                case '1': changeStage('baby'); break;
                case '2': changeStage('child'); break;
                case '3': changeStage('teen'); break;
                case '4': changeStage('adult'); break;
                case '5': changeStage('elder'); break;
                case 'h': changeEmotion('happy'); break;
                case 's': changeEmotion('sad'); break;
                case 'n': changeEmotion('neutral'); break;
                case 'r': resetPosition(); break;
                case 't': testTransition(); break;
            }
        });
    </script>
</body>
</html>